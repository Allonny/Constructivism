#!/bin/bash

# Скрипт для изменения громкости, шоб ~*~*~красивое~*~*~ было

current_level_file="/tmp/volume_levels"

notify_title="Громкость"
notify_body="Текущая громкость системы"
notify_id=$(cat "$(dirname -- "$0")/notify-ids" | grep -oP "${0##*/} \K([\d]+)")

# Создание дефолтного файла-конфигурации с 10 шагами
[[ ! -f $current_level_file ]] && levels 10

# Получить текущую яркость, возвращает число от 0 до 255
get() {
    levels=( $( pactl get-sink-volume @DEFAULT_SINK@ | grep -oP "[\w\p{P}]+\s+\K([\d]+%\s)" | grep -oP "\d+" ) )
    echo $(( ( ${levels[0]} + ${levels[1]} ) / 2 ))
}

# Установить текущую яркость, аргументы: число от 0 до 255
set() {
    pactl set-sink-volume @DEFAULT_SINK@ $1%
}

# Увеличить яркость на один шаг
inc() {
    steps=($(cat $current_level_file))
    [[ ${steps[0]} -lt $(( ${#steps[@]} - 1 )) ]] && steps[0]=$(( ${steps[0]} + 1 ))
    echo ${steps[@]} > $current_level_file
    set ${steps[${steps[0]}]}
    notify
}

# Уменьшить яркость на один шаг
dec() {
    steps=($(cat $current_level_file))
    [[ ${steps[0]} -gt 1 ]] && steps[0]=$(( ${steps[0]} - 1 ))
    echo ${steps[@]} > $current_level_file
    set ${steps[${steps[0]}]}
    notify
}

notify() {
    level=$(get)
    notify-send -u low -r $notify_id "$notify_title" "$notify_body$current_layout" -h int:value:$level
}

# Установить количество шагов, аргументы: два целых неотрицательных чисел
levels() {
    steps=($(python - << EOF
steps = $(( 1 + $1 ))
upsteps = $(( 0 + $2 ))
levels = list(map(lambda x: x * 100 // (steps - 1), range(steps + upsteps)))
print(' '.join(map(str, levels)))
EOF
    ))

    steps=( $(( ${#steps[@]} / 2 )) ${steps[@]})
    echo ${steps[@]} > $current_level_file
    set ${steps[${steps[0]}]}
}


case $1 in
    "get")
        get
        ;;
    "set")
        set "${@:2}"
        ;;
    "inc")
        inc
        ;;
    "dec")
        dec
        ;;
    "levels")
        levels "${@:2}"
        ;;
esac
